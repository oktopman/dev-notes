# 엘라스틱서치를 구성하는 개념
## 기본 용어
### 인덱스
- 데이터 저장 공간
- 하나의 인덱스는 하나의 타입만 가지며, 물리적인 노드에 여러 개의 논리적인 인덱스를 생성 가능
- 검색시 인덱스 이름으로 문서 데이터를 검색하며, 여러 개의 인덱스를 동시에 검색 가능
- ES를 분산 환경으로 구성하면 하나의 인덱스가 여러 노드에 분산 저장되어 관리
- 인덱스 생성시 기본적으로 5개의 프라이머리샤드와 1개의 레플리카 샤드 세팅 생성. 옵션을 이요해 변경가능
- 인덱스 이름은 소문자여야하고, 추가,수정,삭제 검색은 RESTful API 로 수행 가능
- 만약 인덱스가 없는 상태에서 데이터가 추가된다면 데이터를 이용해 인덱스가 자동 생성

### 샤드
- 색인된 문서는 하나의 인덱스에 담기는데, 색인된 데이터는 물리적인 공간에 여러개의 파티션으로 나뉘어 구성되게됨. 이 파티션을 ES에서는 샤드라고 부름
- ES는 다수의 샤드로 문서를 분산저장하여 데이터 손실위험을 취소

### 타입
- 인덱스의 논리적 구조를 의미
- ES 6.1 버전부터는 인덱스 하나당 타입 하나만 사용가능
- 하나의 인덱스에 여러 타입사용하는것을 권장하지않기때문에 사라짐

### 문서(document)
- ES에서 데이터가 저장되는 최소 단위
- 기본적으로 JSON 구조로 저장되지만 중첩구조를 지원하기때문에 문서안에 문서지정 가능

### 필드
- 문서를 구성하기 위한 속성
- 하나의 필드는 목적에 따라 다수의 데이터 타입을 가질수 있음
  - text, keyword 두개의 타입을 가지는것 가능. 매핑으로 데이터를 지정하지않고 데이터가 바로 저장될때 기본적으로 이런 설정잡힘

### 매핑
- 문서의 필드와 필드의 속성을 정의하고 그에 따른 색인방법 정의
- 여러가지 데이터 타입 지정가능하고 필드명 중복X

## 노드의 종류
- 클러스터는 물리적인 노드 인스턴스들의 모임
- 클러스터는 모든 노드의 검색과 색인 작업을 관장하는 노리적인 개념
- 분산 처리를 위해서는 다양한 형태의 노드들을 조합하여 클러스터 구성필요

### 마스터노드
- 클러스터를 관리
- 노드 추가와 제거같은 클러스터 전반적인 관리 담당
- conf 폴더의 elasticsearch.yml 에서 마스터 노드 설정 

### 데이터노드
- 실질적인 데이터 저장
- 검색과 통계 같은 데이터 관련 작업 수행
- conf 폴더의 elasticsearch.yml 에서 마스터 노드 설정

### 코디네이팅 노드
- 사용자의 요청만 받아서 처리
- 클러스터 관련 요청은 마스터 노드에 전달하고 데이터 관련 요청은 데이터 노드에 전달
- conf 폴더의 elasticsearch.yml 에서 마스터 노드 설정

### 인제스트 노드(Ingest Node)
- 문서의 전처리 작업 담당
- 인덱스 생성 전 문서의 형식을 다양하게 변경가능
- 스크립트로 전처리 파이프라인 구성하고 실행 가능
- conf 폴더의 elasticsearch.yml 에서 마스터 노드 설정

## 클러스터,노드,샤드
- 인덱싱시 샤드에 분산되어 노드에 저장
- 샤드는 안정성을 위해 설정한 노드에 하나씩 분산 저장
- 인덱스에 다수의 문서 색인시, 문서는 3개의 샤드로 골고루 분산저장
- ES는 장애시 레플리캬 사드를 이용해 샤드 복구
  - 인덱싱시 프라이머리 샤드와 레플리카 샤드가 서로 다른 노드에 배치저장
  - 샤드를 3개로 지정시, 하나의 노드가 죽더라도 나머지 노드에서 분산저장된 샤드와 레플리카 샤드를 통해 전체 데이터 복구가능. 해당 이유때문에 프라이머리샤드와 레플리카 샤드를 서로 다른 노드에 저장함
  - 장애 발생시 마스터 노드는 데이터를 재분배하거나 레플리카 샤드를 프라이머리 샤드로 승격시켜 서비스 중단없는 복구 가능
  - 상황을 염두해두고 노드와 샤드수 적절히 구성 필요

# ES 에서 제공하는 주요 API
## API 종류
- ES 는 Restful 방식의 API 를 제공하며, 이를 통해 json 기반으로 통신
- 문서를 색인하기 위해 기본적으로 인덱스 생성 필요
- ES 는 편의를 위해 스키마리스 기능 제공
  - 인덱스 생성없이 문서를 추가(인덱싱)하더라도 문서가 색인되도록 지원하는 편의 기능
  - 가급적 사용X
  - 인덱싱시 기본적으로 모든 필드가 text, keyword 타입 동시에 제공하게 구성. 이러한 경우 데이터 공강의 낭비 초래 및 성능 저하
  - 특정 필드에 Analyzer 를 붙여야 하는데, 스키마리스는 기본적으로 Standard Analyzer 가 적용되며 의도와는 다른 형태로 토큰 분석

## 인덱스 관리 API
### 인덱스 생성
```
PUT /movie
{
  "settings": { .... },
  "mappings": { ....}
}
```
- 단순 문자열로 저장하고 싶을때는 keword 타입 사용
- 형태소 분석을 원할경우 text 타입 사용. 검색에 사용되는 필드는 형태소 분석이 가능해야함

### 인덱스 삭제
```
DELETE /movie
```

## 문서관리 API
- 실제 문서를 색인하고 조회,수정,삭제를 지원하는 API
- 색인된 문서를 ID 기준으로 한건의 문서를 다뤄야 하는 경우 문서 관리 API 사용
  - Index API : 한건 색인
  - GET API : 한건 조회
  - DELETE API : 한건 삭제
  - Update API : 한건 업데이트
- 다수의 문서를 처리하는 경우의 API 도 지원
  - Muti GET API, Bulk API ...

## ID 를 지정하지 않고 문서 생성
- 문서(document) 의 _id 값이 UUID를 통해 무작위로 생성됨
- 편해보일수 있지만, 해당 문서를 CRUD 할때 애로사항이 생기기때문에 특정 필드의 값과 맞춰주는게 중요

## 검색 API
- HTTP URI 형태로 조회
```
GET /movie/_doc/search?q=year:2022&pretty=true
```
- QueryDSL 을 사용해 요청본문(Request Body)에 질의 내용을 추가해 검색
```
GET /movie/_doc/search
{
  "query" : {
    "term" : { "typeNm": "장편" }
  }
}
```
- 여러개의 키를 조합해 사용가능
  - size
  - from
  - _source
  - sort
  - query
  - filter

## 집계 API
### 데이터 집계
- 문서를 특정 필드별로 집계 가능
```
GET /movie/_search
{
  "aggs": {
    "genre": {
      "terms": {
        "field": "genreAlt"
      }
    }
  }
}

// 결과. 편의상 유의미한부분은 적겠음
{
  "took": 10,
  "shards": {....}
  "hits" : {
    "max_score" : 0 // 집계는 스코어를 계산 불가
  },
  "aggregations": {
    "genre": {
      ...
      "buckets": [
        {
          "key" : "드라마",
          "doc_count" : 19856
        },
        {
          "key" : "코미디",
          "doc_count" : 4412
        }
        ...
      ]
    }
  }
}

```
- 버킷이라는 구조안에 그룹화된 데이터가 포함
- 버킷안에 다른 버킷을 결과 추가가능
- 집계 유형을 결합하거나 중첩, 조합 가능
```
GET /movie/_search
{
  "aggs": {
    "genre": {
      "terms": {
        "field": "genreAlt"
      },
      "aggs": {
        "nation": {
          "terms": {
            "field": "nationAlt"
          }
        }
      }
    }
  }
}

// 결과. 
...
"aggregations": {
    "genre": {
      ...
      "buckets": [
        {
          "key" : "드라마",
          "doc_count" : 19856,
          "nation": {
            ...
            "buckets": {
              "key": "한국",
              "doc_count": 3123
            }
          }
        },
        {
          "key" : "코미디",
          "doc_count" : 4412,
          "nation": {
            ...
            "buckets": {
              "key": "미국",
              "doc_count": 333
            }
          }
        }
        ...
      ]
    }
  }

```
### 데이터 집계 타입
- 집계 기능은 4가지 제공되며 서로 조합해 사용가능
  - 버킷 집계 : 가장 많이 사용됨. 문서의 필드기준으로 버킷 집계
  - 메트릭 집계 : 문서에서 추출된 값을 가지고 sum, max, min, avg 계산
  - 매트릭스 집계
  - 파이프라인 집계 : 버킷에서 도출된 결과 문서를 다른 필드값으로 재분류. 다른 집계에 의해 생성된 출력 결과를 다시한번 집계함. 아주 강력

## 참고
http://www.yes24.com/Product/Goods/71893929