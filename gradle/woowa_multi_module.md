# 우아한 멀티모듈

하나의 프로젝트에서 여러 모듈을 생성 가능하다.  
각 모듈들은 독립적이고 필요한 최소한 의존성만 가지고 있게 구성(싱글모듈로 구성하면 배치와 api 에 필요없는 의존성을 가지게 됨)  
MSA 에서 멀티모듈이 부각되는 이유는 역할, 의존성분리를 통해 시스템의 분리,통합을 유연하게 만들어줄수 있는 좋은 아키텍쳐 설계 가능

### 실패한 멀티모듈 구성 경험
- 공통되는 코드를 제거할수 있다는 생각
- 공통되는 것들을 common(core) 로 빼서 관리
- 중복이 발생하는것을 common 에 넣음
- 코드중복을 최소화 한다는 생각으로 common 에 몰아넣음
- Common 이 커질수록 common 에 비지니스로직이 점점 추가될수밖에 없어서 common 이 커지게 됨. 추후 common 이 제일 커지게됨
- 이렇게 되면서 힘들었더점
    - 스파게티코드
        - Common 에 몰아넣다 보니 굉장히 많은 클래스가 알수없는 형태로 클래스들간에 서로서로 호출하게 됨
        - 추후 common 을 분리하고 싶어도 힘들게됨. 특정 기능이 없어지게 되면서 그 기능을 걷어내려고해도 common 에서 사용되고있거나 그 코드를 삭제하게 되더라도 사이드이펙트발생. 관련된 굉장히 많은 코드가 있어서 파악하기도 힘듬
    - 의존성 덩어리가 생김
        - Common 에서 비즈니스의 플로우가 흐르다보니 application 에서 사용할수 있는 의존성을 다 끌어다 쓰게 됨.
        - Common 에서 의존성을 가지고있다보니, common 과 관계되어있는 모듈에서 필요없는 의존성들을 가지게 됨(ex: batch 에서 spring-mvc 같은). 사용하지않는 의존성때문에 해당 모듈에서 장애 발생가능성(dynamo가 내부적으로 jetty 를 띄워서 엄청 당황. 이런문제를 만났을때 어디가 문제인지 파악하기 힘듬)
    - 공통설정
        - Common 안에 서비스의 대부분의 설정까지도 넣었는데, 중앙집중된 설정으로 인해 datasource 커넥션문제가 발생. 다른 모듈에서 필요하지않은 db 의존성때문에 실제 필요한 모듈에서 풀이 모자란 경우가 발생
- 무엇이 문제였을까?
    - 모듈에 대한 정의가 모호
        - Common 같은 광범위한 의미를 가지는 모듈(네이밍이 굉장히 중요)
- 모듈화란?
    - 각 기능이 명확한 것들끼리 모여서
    - 어플리케이션 안에 내가 필요한 의존만을 넣는
- 무엇을 중심으로 정의 내려야 할까?
    - 역할과 책임이 명확하게 모듈을 분리
        - 역할과 책임에 대한 범위는?
            - 잘 만들어져있는 스프링같은 라이브러리들을 염탐
                - 멀티모듈로 구성하면서도 계층 이라는것이 존재
                - 각 계층이 역할과 책임을 가지는 모듈이 존재
                - 계층간의 약속이나 규약을 명확하게 설계
- 스프링 프로젝트의 계층을 보았는데 와닿지가 않음
    - Spring-aop, spring-beans, spring-context 등등 으로 모듈화 되어있는데, 서비스를 만드는 입장으로써 전혀 와닿지 않음
- 왜 이런 괴리감이 발생할까?
    - 라이브러리의 목적?
        - 사용성, 기능목적
    - 우리가 만드는 어플리케이션의 목적?
        - 서비스 제공 !!
- 직접 계층, 역할을 나누어보아야겠다라고 생각

### 명확한 기준으로 개인적인 멀티 모듈을 구성
- 시스템
    - 독립적으로 실행가능한 어플리케이션을 서비스라고 부른다
    - 1개 이상의 서비스와 공유 인프라가 모여 하나의 시스템을 구성한다
- 어플리케이션 비지니스, 도메인 비지니스
    - **주문 요청 API**
  ```
  1. 요청 값 검증
      2. 주문 요청
        a. 주문 데이터 생성
        b. 주문 데이터 검증
        c. 주문 데이터 저장
      3. 주문 결과 처리 
      4. 응답
    ```
- 어플리케이션 비지니스 : 1,2,3,4 - 요청과 응답에 대한 흐름을 제어
- 도메인 비지니스 : a,b,c - 하나의 도메인안에서 생성되고 변경,소멸되는 라이프사이클을 가지는것
- 새로운 시각
    - 일반 레이어드 아키텍쳐가 아닌 다른 시점으로 바라봄

### 레이어구상
- 시스템 내부
    - 어플리케이션
    - 내부모듈 ——— 도메인모듈
    - 공통모듈

### 레이어 분석 
#### 내부모듈 : 여러 서버와의 통신. 외부 통신을 담당하는 모듈
- 환경별 시스템 host, header 관리
- 요청, 응답 spec 관리
- 예외 처리 추상화 수준 통일
- 실행되지않는 어플리케이션은 bootJar 의 enabled = false 옵션적용
- 외부요청만 할것이기때문에 spring-boot-starter, spring-web, rest template 과 같은 최소의존성만 가짐
- 클라이언트(서버)를 만들때 이 클라이언트에서는 절대로 exception 이 세어나가지 않는다. Exception 을 다 잡아서 처리하고 클라이언트를 사용하는쪽에서는 fail,success 만 잘 확용해서 처리하면된다.

![image](https://user-images.githubusercontent.com/55048593/149789168-6e27e17d-f362-4ac1-8c9e-cf018dd684a1.png)
- 스펙변경에 대한 단일 변경 포인트는 여기밖에 없다. 그래서 이쪽만 보고 스펙변경을 할수있다.
- 사용 추적 쉬움

#### 도메인 모듈
- 어플리케이션 비지니스를 모른다는 전재
- 하나의 모듈은 최대 하나의 인프라스트럭처에 대한 책임만 갖는다
- 도메인 모듈을 조합한 더 큰 단위의 도메인 모듈이 있을 수 있다
- 순수성을 위해서 실용성을 포기하는것은 어리석은일. 완벽한 객체지향을 구현하기는 어렵다. 그래서 jpa, querydsl 같은 의존성을 가지게 되었음
- 도메인모듈도 여러개로 구성, 인프라스트럭처를 분리
    - Domain-redis
        - Infrastructure 연동관리
        - 도메인 계층 구현
    - Domain-dynamo
        - Infrastructure 연동관리
        - 도메인 계층 구현
    - Domain-redis, domain-dynamo 사이에 fallback 이 흐름
        - Redis 에 데이터가 없다면 dynamo 에서 가져와서 저장

    - Domain-redis, domain-dynamo 를 관리하는 domain service module 구현
      ![image](https://user-images.githubusercontent.com/55048593/149789739-b72e3235-fad9-4879-8078-10723eff55c3.png)
      ![image](https://user-images.githubusercontent.com/55048593/149789863-40e7ea75-c56d-4fb6-8e3f-9d4ce9900e29.png)

#### 공통모듈
- type(enum), util 등을 정의
- 의존성을 가져가지 않는 큰 제약
- 자바클래스만 작성가능. 이부분도 실용적인 관점에서 필요하다면 확장가능

#### 어플리케이션 모듈
![image](https://user-images.githubusercontent.com/55048593/149790117-ad2b3f20-55fb-4c22-9814-69cb0b536bbe.png)

#### 최종 모듈 의존 관계
![image](https://user-images.githubusercontent.com/55048593/149790588-e7de14cc-770b-4e50-b089-dfe25349c6a6.png)
![image](https://user-images.githubusercontent.com/55048593/149790652-b7a172a0-a435-423c-9034-de1d511dea23.png)

- 명확한 추상화 경계가 잡힘
- 각 모듈이 갖는 책임과 역할이 명확하여 리팩토링, 기능의 변경의 영향범위를 파악하기 용이
- 경계가 명확해짐으로써 기능의 제공 정도를 예측 가능하여 스파게티코드 발생 가능성 저하
- 역할과 책임에 대한 애매함이 없어짐으로써 어떤 모듈로써 어느정도까지 개발되어야할지 명확
- 최소한의 의존성만 가져가게 됨

## 아래 링크의 영상과 블로그를 정리
- https://www.youtube.com/watch?v=nH382BcycHc
- https://jojoldu.tistory.com/444
